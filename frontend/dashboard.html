<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Mechanisms Dashboard — Final (QoC + Fixes)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">

<!-- jQuery (must load before Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 CSS & JS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>

<!-- ECharts -->
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>

<style>
:root{
  --primary:#1976d2;
  --bg:#f5f7fb;
  --surface:#fff;
  --muted:#6b7280;
  --card-radius:12px;
}
html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:var(--bg);color:#111;}
.header{background:var(--primary);color:#fff;padding:12px 18px;font-size:20px;font-weight:700;}
.container{padding:12px 18px 40px;}
.filter-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px;align-items:end;}
.filter { min-width:180px; max-width:300px; }
.select2-container--default .select2-selection--multiple, .select2-container--default .select2-selection--single {
  min-height:38px; border-radius:8px; border:1px solid #d0d7e6; padding:4px;
}
.select2-dropdown { z-index:2147483647 !important; }
.summary { display:flex; gap:12px; margin-bottom:12px; }
.card { background:var(--surface); border-radius:var(--card-radius); padding:12px; box-shadow:0 6px 18px rgba(16,24,40,0.04); flex:1; }
.card h4{ margin:0;font-size:12px;color:var(--muted); }
.card .val{ font-size:22px; font-weight:800; color:var(--primary); margin-top:6px;}
.tabs{display:flex;gap:8px;margin:8px 0 12px;}
.tab{padding:8px 12px;border-radius:8px;background:#eef7ff;color:var(--primary);cursor:pointer;font-weight:700;}
.tab.active{background:var(--primary);color:white;}
.chart-grid-2{display:grid;grid-template-columns:1fr 420px;gap:12px;}
.chart-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}
.chart-box{background:var(--surface);border-radius:10px;padding:8px;height:420px;box-shadow:0 8px 24px rgba(16,24,40,0.04);overflow:hidden;}
.chart-box.tall{height:520px;}
.echart-wrap{width:100%;height:100%;}
.small{font-size:12px;color:var(--muted);}
@media(max-width:1100px){ .chart-grid-2{grid-template-columns:1fr;} .chart-grid-3{grid-template-columns:1fr;} .filter{min-width:140px;} }
</style>
</head>

<body>
<div class="header">Mechanisms Dashboard — QoC & Achievement</div>
<div class="container">

  <!-- Filters (shared across tabs) -->
  <div class="filter-row">
    <div class="filter">
      <label class="small">Fiscal Year</label>
      <select id="fyFilter" multiple style="width:100%"></select>
    </div>
    <div class="filter">
      <label class="small">Partner</label>
      <select id="partnerFilter" multiple style="width:100%"></select>
    </div>
    <div class="filter">
      <label class="small">Mechanism</label>
      <select id="mechanismFilter" multiple style="width:100%"></select>
    </div>
    <div class="filter">
      <label class="small">Indicator</label>
      <select id="indicatorFilter" multiple style="width:100%"></select>
    </div>
    <div class="filter">
      <label class="small">Numerator/Denominator</label>
      <select id="numDenFilter" multiple style="width:100%"></select>
    </div>
    <div style="margin-left:auto">
      <button id="resetFilters" style="padding:8px 12px;border-radius:8px;background:var(--primary);color:white;border:none;cursor:pointer">Reset</button>
    </div>
  </div>

  <!-- Summary -->
  <div class="summary">
    <div class="card"><h4>Unique Partners</h4><div id="partnerCount" class="val">0</div></div>
    <div class="card"><h4>Unique Mechanisms</h4><div id="mechCount" class="val">0</div></div>
    <div class="card"><h4>Overall Achievement</h4><div id="overallSummaryPct" class="val">0%</div></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="tab-ach">Achievements</div>
    <div class="tab" data-tab="tab-trend">Trends & Insights</div>
    <div class="tab" data-tab="tab-qoc">Quality of Care (QoC)</div>
  </div>

  <!-- Achievements tab -->
  <div id="tab-ach" class="tab-content" style="display:block">
    <div class="chart-grid-2">
      <div class="chart-box" id="targetChart"><div id="targetChart_wrap" class="echart-wrap"></div></div>
      <div class="chart-box" id="gaugeBox"><div id="gauge_wrap" class="echart-wrap"></div></div>
    </div>

    <div style="height:12px"></div>

    <div class="chart-grid-2">
      <div class="chart-box" id="partnerChart"><div id="partnerChart_wrap" class="echart-wrap"></div></div>
      <div class="chart-box" id="mechanismChart"><div id="mechanismChart_wrap" class="echart-wrap"></div></div>
    </div>

    <div style="height:12px"></div>

    <div class="chart-box" id="bottomIndicators"><div id="bottomIndicators_wrap" class="echart-wrap"></div></div>
  </div>

  <!-- Trends tab -->
  <div id="tab-trend" class="tab-content" style="display:none">
    <div class="chart-box tall" id="quarterlyTrend"><div id="quarterlyTrend_wrap" class="echart-wrap"></div></div>
    <div style="height:12px"></div>
    <div class="chart-grid-3">
      <div class="chart-box" id="topIndicators"><div id="topIndicators_wrap" class="echart-wrap"></div></div>
      <div class="chart-box" id="topPartners"><div id="topPartners_wrap" class="echart-wrap"></div></div>
      <div class="chart-box" id="topMechanisms"><div id="topMechanisms_wrap" class="echart-wrap"></div></div>
    </div>
  </div>

  <!-- QoC tab -->
  <div id="tab-qoc" class="tab-content" style="display:none">
    <div class="chart-grid-3">
      <div class="chart-box"><div id="qocLineRace_wrap" class="echart-wrap"></div></div>
      <div class="chart-box"><div id="qocBarRace_wrap" class="echart-wrap"></div></div>
      <div class="chart-box"><div id="qocNumDen_wrap" class="echart-wrap"></div></div>
    </div>
    <div style="height:12px"></div>
    <div class="small">QoC charts use shared filters. Use Numerator/Denominator filter to isolate numerator or denominator metrics.</div>
  </div>

</div> <!-- container -->

<!-- Scripts: Part 3 comes next -->


<script>
/* Dashboard JS — updated: additive logic, legends, quarterly axes, QoC, num/den filter
   API endpoint:
*/
const API_URL = "http://127.0.0.1:8000/api/mechanisms";

/* Indicator families — adjust as needed */
const additiveIndicators = new Set(["AGYW_PREV","CXCA_SCRN","CXCA_SCRN_POS","CXCA_TX","HTS_INDEX","HTS_INDEX_KNOWNPOS","HTS_INDEX_NEWNEG","HTS_INDEX_NEWPOS","HTS_RECENT","HTS_SELF","HTS_TST","HTS_TST_NEG","HTS_TST_POS","OVC_HIVSTAT","OVC_HIVSTAT_NEG","OVC_HIVSTAT_POS","OVC_SERV","PMTCT_ART","PMTCT_EID","PMTCT_HEI","PMTCT_HEI_POS","PMTCT_STAT","PMTCT_STAT_POS","POST_RESP","PP_PREV","PrEP_NEW","TB_ART","TB_PREV","TB_STAT","TX_NEW","TX_RET","VMMC_CIRC"]);
const nonAdditiveIndicators = new Set(["PrEP_CT","PrEP_CURR","TX_CURR","TX_PVLS","TX_TB"]);

/* Storage */
let raw = null;
let charts = {};
const N = v => (v===null||v===undefined||v===''?0:Number(v));

/* Formatting helpers */
function fmtN(n){ return Number(n).toLocaleString(); }
function fmtPct(p, digits=0){ return `${p==null?0: (Math.round(p* Math.pow(10,digits)) / Math.pow(10,digits))}%`; }
function labelCountPct(count,pct){ return `${fmtN(count)} (${Math.round(pct)}%)`; }

/* Init Select2 on filters */
function initFilters() {
  const selIds = ['#fyFilter','#partnerFilter','#mechanismFilter','#indicatorFilter','#numDenFilter'];
  selIds.forEach(id => {
    if ($(id).length) {
      $(id).select2({ placeholder:'All', allowClear:true, width: 'resolve' });
    }
  });

  // Reset button
  $('#resetFilters').on('click', ()=> {
    selIds.forEach(id=> { $(id).val(null).trigger('change'); });
    refreshAll();
  });

  // Tab switch
  $('.tab').on('click', function(){
    $('.tab').removeClass('active');
    $(this).addClass('active');
    const tab = $(this).data('tab');
    $('.tab-content').hide();
    $('#' + tab).show();
    setTimeout(()=> Object.values(charts).forEach(c=>c&&c.resize()),120);
  });

  // On filter change refresh
  $('#fyFilter,#partnerFilter,#mechanismFilter,#indicatorFilter,#numDenFilter').on('change', ()=> refreshAll());
}

/* Heuristic to classify record as Numerator / Denominator / Proportion / Other
   - If record has field 'Num' or 'Numerator' (case-ins) => Numerator
   - If record has field 'Denominator' or ends with _D => Denominator
   - If indicator in proportion list or name contains 'ratio' or 'rate' or 'proportion' or ends with _R => Proportion
   - Else Other
*/
function classifyNumDen(record) {
  const name = (record.Indicator || '').toString().toUpperCase();
  // explicit fields
  if ('Numerator' in record || 'Num' in record) return 'Numerator';
  if ('Denominator' in record || 'Den' in record) return 'Denominator';
  if (/_N$/.test(name) || name.includes(' NUM') || name.includes('_NUM')) return 'Numerator';
  if (/_D$/.test(name) || name.includes(' DEN') || name.includes('_DEN')) return 'Denominator';
  if (name.includes('RATE') || name.includes('RATIO') || name.includes('PROPORTION') || name.endsWith('_R') || nonAdditiveIndicators.has(name)) return 'Proportion';
  return 'Other';
}

/* Load API and preprocess records (compute cum_total per indicator respecting additive rules) */
async function loadData() {
  try {
    const res = await fetch(API_URL);
    if(!res.ok) throw new Error('HTTP ' + res.status);
    raw = await res.json();

    // compute _computed for each record
    (raw.records || []).forEach(r => {
      // Determine cum_total following additive/non-additive
      let cum = 0;
      const ind = (r.Indicator || '').toString();
      if (additiveIndicators.has(ind)) {
        cum = N(r["Quarter 1"]) + N(r["Quarter 2"]) + N(r["Quarter 3"]) + N(r["Quarter 4"]);
      } else if (nonAdditiveIndicators.has(ind)) {
        cum = N(r["Quarter 4"]) || N(r["Quarter 3"]) || N(r["Quarter 2"]) || N(r["Quarter 1"]) || 0;
      } else {
        // fallback: if there is an explicit 'Numerator' and 'Denominator' fields, prefer Numerator as cum
        if ('Numerator' in r) cum = N(r.Numerator);
        else cum = N(r["Quarter 1"]) + N(r["Quarter 2"]) + N(r["Quarter 3"]) + N(r["Quarter 4"]);
      }
      const targ = (r.Targets===null||r.Targets===undefined)?0:N(r.Targets);
      r._computed = { cum_total: cum, targets: targ, percent: (targ? (cum / targ * 100) : 0), numDenClass: classifyNumDen(r) };
    });

    // populate filters
    populateFilters();
    initFilters();
    refreshAll();

    // resize charts on window resize
    window.addEventListener('resize', ()=> Object.values(charts).forEach(c=>c&&c.resize()));
  } catch(err) {
    console.error('Load error', err);
    alert('Failed to load API: ' + err.message);
  }
}

/* Populate filters from raw */
function populateFilters() {
  const recs = raw.records || [];
  const unique = (k) => [...new Set(recs.map(r => r[k]).filter(Boolean))].sort((a,b)=>(''+a).localeCompare(''+b));
  const years = unique('Fiscal Year').map(String);
  const partners = unique('Partner Name');
  const mechs = unique('Mechanism Name');
  const inds = unique('Indicator');

  // fill selects
  const setOpts = (sel, arr) => {
    const $s = $(sel);
    $s.empty();
    arr.forEach(v => $s.append(new Option(v, v, false, false)));
    $s.trigger('change');
  };

  setOpts('#fyFilter', years);
  setOpts('#partnerFilter', partners);
  setOpts('#mechanismFilter', mechs);
  setOpts('#indicatorFilter', inds);

  // Numerator/Denominator options based on heuristics found
  const numDenClasses = ['Numerator','Denominator','Proportion','Other'];
  setOpts('#numDenFilter', numDenClasses);
}

/* Get filtered records respecting shared filters */
function getFilteredRecords() {
  const fy = $('#fyFilter').val() || [];
  const partner = $('#partnerFilter').val() || [];
  const mech = $('#mechanismFilter').val() || [];
  const ind = $('#indicatorFilter').val() || [];
  const numden = $('#numDenFilter').val() || [];

  return (raw.records || []).filter(r => {
    if (fy.length && !fy.includes(String(r["Fiscal Year"]))) return false;
    if (partner.length && !partner.includes(r["Partner Name"])) return false;
    if (mech.length && !mech.includes(r["Mechanism Name"])) return false;
    if (ind.length && !ind.includes(r.Indicator)) return false;
    if (numden.length && !numden.includes(r._computed.numDenClass)) return false;
    return true;
  });
}

/* ---------- CHART UTILITIES ---------- */
function safeInit(id) {
  charts[id] = charts[id] || echarts.init(document.getElementById(id + '_wrap'));
  return charts[id];
}

/* shared dataZoom for horizontal category axes */
function horizontalDataZoom() {
  return [
    { type:'slider', show:true, start:0, end:40, height:10, bottom:8 },
    { type:'inside' }
  ];
}

/* ---------- 1. Targets chart (bars represent % achievements) ---------- */
function renderTargetsChart(recs) {
  const ch = safeInit('targetChart');
  const years = [...new Set(recs.map(r => String(r["Fiscal Year"])).filter(Boolean))].sort();
  if (!years.length) { ch.setOption({ title:{text:'No data'}, series:[] }); return; }

  // compute totals per year following _computed.percent semantics
  const totalTargets = years.map(y => recs.filter(r=>String(r["Fiscal Year"])===y).reduce((s,r)=>s + (r._computed? r._computed.targets:0),0));
  const totalAch = years.map(y => recs.filter(r=>String(r["Fiscal Year"])===y).reduce((s,r)=>s + (r._computed? r._computed.cum_total:0),0));
  const pct = years.map((y,i)=> totalTargets[i] ? (totalAch[i] / totalTargets[i] * 100) : 0);

  const option = {
    title:{ text:'Achievement (% basis) — Fiscal Year', left:'center' },
    tooltip:{ trigger:'axis', formatter: params => {
      const i = params[0].dataIndex;
      return `${years[i]}<br>Targets: ${fmtN(totalTargets[i])}<br>Achieved: ${fmtN(totalAch[i])} (${Math.round(pct[i])}%)`;
    }},
    legend: { top: 10, data: ['% Achieved'], selectedMode:'multiple' },
    grid: { left:80, right:40, top:80, bottom:90 },
    xAxis: { type:'category', data: years, axisLabel:{ interval:0, rotate:0, formatter:v=>v } },
    yAxis: { type:'value', name:'% Achievement', min:0, max: Math.max(...pct,10)*1.2, axisLabel:{ formatter: v => `${Math.round(v)}%` } },
    dataZoom: horizontalDataZoom(),
    series: [{
      name: '% Achieved',
      type: 'bar',
      data: pct.map(v => +(v.toFixed(2))),
      itemStyle:{ color:'#1976d2' },
      label:{ show:true, position:'top', formatter: params => {
        const idx = params.dataIndex;
        return labelCountPct(totalAch[idx], pct[idx]);
      }}
    }]
  };
  ch.setOption(option);
}

/* ---------- 2. Partner chart (bars = % achievement) ---------- */
function renderPartnerChart(recs) {
  const ch = safeInit('partnerChart');
  // aggregate by partner
  const partners = [...new Set(recs.map(r=>r["Partner Name"]).filter(Boolean))];
  const agg = partners.map(p=>{
    const rs = recs.filter(r=>r["Partner Name"]===p);
    const targ = rs.reduce((s,r)=>s + (r._computed? r._computed.targets:0),0);
    const ach = rs.reduce((s,r)=>s + (r._computed? r._computed.cum_total:0),0);
    const pct = targ? (ach / targ * 100) : 0;
    return { p, targ, ach, pct };
  }).filter(x=> (x.targ>0 || x.ach>0)).sort((a,b)=>a.pct - b.pct); // ASC

  const names = agg.map(x=>x.p);
  const pctVals = agg.map(x=>+(x.pct.toFixed(2)));
  const achVals = agg.map(x=>x.ach);
  const targVals = agg.map(x=>x.targ);

  const option = {
    title:{ text:'Partners — % Achievement (ascending)', left:'center' },
    tooltip:{ trigger:'axis', axisPointer:{ type:'shadow' }, formatter: params => {
      const i = params[0].dataIndex;
      return `${names[i]}<br>Targets: ${fmtN(targVals[i])}<br>Achieved: ${fmtN(achVals[i])} (${Math.round(pctVals[i])}%)`;
    }},
    legend:{ top:10, data:['% Achieved'], selectedMode:'multiple' },
    grid:{ left:180, right:80, top:80, bottom:60 },
    xAxis:{ type:'value', name:'% Achievement', axisLabel:{ formatter: v => `${Math.round(v)}%` } },
    yAxis:{ type:'category', data: names, axisLabel:{ interval:0 } },
    series:[{
      name:'% Achieved',
      type:'bar',
      data: pctVals,
      itemStyle:{ color:'#2e7d32' },
      label:{ show:true, position:'right', formatter: p => {
        const i = p.dataIndex;
        return labelCountPct(achVals[i], pctVals[i]);
      }}
    }],
    dataZoom: [ { type:'slider', show:true, yAxisIndex:0, start:0, end:40 }, { type:'inside', yAxisIndex:0 } ]
  };
  ch.setOption(option);
}

/* ---------- 3. Mechanism chart (bars = % achievement) ---------- */
function renderMechanismChart(recs) {
  const ch = safeInit('mechanismChart');
  const mechs = [...new Set(recs.map(r=>r["Mechanism Name"]).filter(Boolean))];
  const agg = mechs.map(m=>{
    const rs = recs.filter(r=>r["Mechanism Name"]===m);
    const targ = rs.reduce((s,r)=>s + (r._computed? r._computed.targets:0),0);
    const ach = rs.reduce((s,r)=>s + (r._computed? r._computed.cum_total:0),0);
    const pct = targ? (ach / targ * 100) : 0;
    return { m, targ, ach, pct };
  }).filter(x=> (x.targ>0 || x.ach>0)).sort((a,b)=>a.pct - b.pct); // ASC

  const names = agg.map(x=>x.m);
  const pctVals = agg.map(x=>+(x.pct.toFixed(2)));
  const achVals = agg.map(x=>x.ach);
  const targVals = agg.map(x=>x.targ);

  const option = {
    title:{ text:'Mechanisms — % Achievement (ascending)', left:'center' },
    tooltip:{ trigger:'axis', axisPointer:{ type:'shadow' }, formatter: params => {
      const i = params[0].dataIndex;
      return `${names[i]}<br>Targets: ${fmtN(targVals[i])}<br>Achieved: ${fmtN(achVals[i])} (${Math.round(pctVals[i])}%)`;
    }},
    legend:{ top:10, data:['% Achieved'], selectedMode:'multiple' },
    grid:{ left:180, right:80, top:80, bottom:60 },
    xAxis:{ type:'value', name:'% Achievement', axisLabel:{ formatter: v => `${Math.round(v)}%` } },
    yAxis:{ type:'category', data: names, axisLabel:{ interval:0 } },
    series:[{
      name:'% Achieved',
      type:'bar',
      data: pctVals,
      itemStyle:{ color:'#1976d2' },
      label:{ show:true, position:'right', formatter: p => {
        const i = p.dataIndex;
        return labelCountPct(achVals[i], pctVals[i]);
      }}
    }],
    dataZoom: [ { type:'slider', show:true, yAxisIndex:0, start:0, end:40 }, { type:'inside', yAxisIndex:0 } ]
  };
  ch.setOption(option);
}

/* ---------- 4. Bottom indicators (excludes blanks/zeros) ---------- */
function renderBottomIndicators(recs) {
  const ch = safeInit('bottomIndicators');
  const inds = [...new Set(recs.map(r=>r.Indicator).filter(Boolean))];
  const agg = inds.map(ind=>{
    const rs = recs.filter(r=>r.Indicator===ind);
    const targ = rs.reduce((s,r)=>s + (r._computed? r._computed.targets:0),0);
    const ach = rs.reduce((s,r)=>s + (r._computed? r._computed.cum_total:0),0);
    const pct = targ? (ach / targ * 100):0;
    return { ind, targ, ach, pct };
  }).filter(x=>x.targ>0 && x.ach>0).sort((a,b)=>a.pct - b.pct).slice(0,10);

  const names = agg.map(x=>x.ind);
  const pctVals = agg.map(x=>+(x.pct.toFixed(2)));
  const achVals = agg.map(x=>x.ach);
  const targVals = agg.map(x=>x.targ);

  const option = {
    title:{ text:'Bottom 10 Indicators (excl blanks/zeros)', left:'center' },
    tooltip:{ trigger:'axis', formatter: params => {
      const i = params[0].dataIndex;
      return `${names[i]}<br>Targets: ${fmtN(targVals[i])}<br>Achieved: ${fmtN(achVals[i])} (${Math.round(pctVals[i])}%)`;
    }},
    legend:{ top:10, data:['% Achieved'], selectedMode:'multiple' },
    grid:{ left:120, right:80, top:80, bottom:60 },
    xAxis:{ type:'value', name:'% Achievement', axisLabel:{ formatter: v => `${Math.round(v)}%` } },
    yAxis:{ type:'category', data: names, axisLabel:{ interval:0 } },
    series:[{ type:'bar', data:pctVals, itemStyle:{ color:'#e53935' }, label:{ show:true, position:'right', formatter:(p)=> labelCountPct(achVals[p.dataIndex], pctVals[p.dataIndex]) } }],
    dataZoom: [ { type:'slider', show:true, yAxisIndex:0, start:0, end:60 }, { type:'inside', yAxisIndex:0 } ]
  };
  ch.setOption(option);
}

/* ---------- 5. Quarterly Trend — Quarters on TOP, Fiscal years BELOW ---------- */
function renderQuarterlyTrend(recs) {
  const ch = safeInit('quarterlyTrend');

  const years = [...new Set(recs.map(r=>String(r["Fiscal Year"])).filter(Boolean))].sort();
  const yearsToUse = years.slice(-5);
  if (!yearsToUse.length) { ch.setOption({ title:{text:'No quarterly data'}, series:[] }); return; }

  const quarters = ['Q1','Q2','Q3','Q4'];
  const categoryPairs = [];
  yearsToUse.forEach(y => quarters.forEach(q => categoryPairs.push({ year:y, quarter:q })));
  const dataVals = categoryPairs.map(cp => {
    const rs = recs.filter(r=>String(r["Fiscal Year"])===cp.year);
    if(!rs.length) return 0;
    if (cp.quarter==='Q1') return rs.reduce((s,r)=>s + N(r["Quarter 1"]),0);
    if (cp.quarter==='Q2') return rs.reduce((s,r)=>s + N(r["Quarter 2"]),0);
    if (cp.quarter==='Q3') return rs.reduce((s,r)=>s + N(r["Quarter 3"]),0);
    if (cp.quarter==='Q4') return rs.reduce((s,r)=>s + N(r["Quarter 4"]),0);
    return 0;
  });

  // avg quarter target for percent
  const totalTargets = recs.reduce((s,r)=>s + (r._computed? r._computed.targets:0),0);
  const avgQuarterTarget = totalTargets? (totalTargets / (yearsToUse.length * 4)) : 0;
  const dataPct = dataVals.map(v => avgQuarterTarget ? (v / avgQuarterTarget * 100) : 0);

  // x-axis lists
  const xAxisQuarters = categoryPairs.map(cp => cp.quarter); // repeated quarters (top)
  // years row: show year only for first quarter of its group, else show empty to avoid repeating
  const xAxisYears = categoryPairs.map((cp, idx) => (idx % 4 === 0 ? cp.year : ''));

  const option = {
    title:{ text:'Quarterly Trend — Quarters (top) | Fiscal Year (below)', left:'center' },
    tooltip:{ trigger:'axis', axisPointer:{ type:'shadow' }, formatter: params => {
      const p = params[0];
      const idx = p.dataIndex;
      const cp = categoryPairs[idx] || {};
      return `${cp.year} ${cp.quarter}<br>Total: ${fmtN(dataVals[idx])} (${Math.round(dataPct[idx])}%)`;
    }},
    legend:{ top:10, data:['Total','% Achievement'], selectedMode:'multiple' },
    grid:{ left:70, right:80, top:90, bottom:120 },
    xAxis:[
      { // quarters (top)
        type:'category', position:'bottom', offset:0, data:xAxisQuarters,
        axisLabel:{ interval:0, fontSize:12, formatter: v => v }
      },
      { // years (below)
        type:'category', position:'bottom', offset:36, data:xAxisYears,
        axisLabel:{ interval:0, fontSize:12, formatter: v => v }
      }
    ],
    yAxis:[
      { type:'value', name:'Count', axisLabel:{ formatter: v => fmtN(v) } },
      { type:'value', name:'% Achievement', position:'right', min:0, max: Math.max(...dataPct,10) * 1.25, axisLabel:{ formatter: v => `${Math.round(v)}%` } }
    ],
    dataZoom: [ { type:'slider', show:true, start:0, end:40, bottom:12 }, { type:'inside' } ],
    series:[
      { name:'Total', type:'bar', xAxisIndex:0, data:dataVals, itemStyle:{ color:'#1976d2' }, label:{ show:true, position:'top', formatter: p => labelCountPct(dataVals[p.dataIndex], dataPct[p.dataIndex]) } },
      { name:'% Achievement', type:'line', yAxisIndex:1, xAxisIndex:0, data:dataPct.map(v=>+(v.toFixed(2))), smooth:true, symbol:'circle', symbolSize:6, itemStyle:{ color:'#ff9800' } }
    ]
  };

  ch.setOption(option);
  ch.resize();
}

/* ---------- 6. Trends & Insights small charts (top partners/mechanisms/indicators) ---------- */
function renderSmallTrends(recs) {
  // topIndicators
  const topIndCh = safeInit('topIndicators');
  const topPartnersCh = safeInit('topPartners');
  const topMechsCh = safeInit('topMechanisms');

  // indicators
  const inds = [...new Set(recs.map(r=>r.Indicator).filter(Boolean))];
  const indAgg = inds.map(ind => {
    const rs = recs.filter(r=>r.Indicator===ind);
    const targ = rs.reduce((s,r)=>s + (r._computed? r._computed.targets:0),0);
    const ach = rs.reduce((s,r)=>s + (r._computed? r._computed.cum_total:0),0);
    const pct = targ? (ach / targ * 100) : 0;
    return { ind, pct };
  }).filter(x=>x.pct!==undefined).sort((a,b)=>b.pct - a.pct).slice(0,10);

  topIndCh.setOption({
    title:{ text:'Top Indicators (% Achieved)', left:'center' },
    legend:{ top:10 },
    xAxis:{ type:'category', data: indAgg.map(x=>x.ind), axisLabel:{ rotate:45 } },
    yAxis:{ type:'value', min:0, max: Math.max(...indAgg.map(x=>x.pct),10)*1.25 },
    series:[ { type:'bar', data: indAgg.map(x=>Math.round(x.pct)), label:{ show:true, formatter:'{c}%' } } ]
  });

  // partners
  const partners = [...new Set(recs.map(r=>r["Partner Name"]).filter(Boolean))];
  const pAgg = partners.map(p=> {
    const rs = recs.filter(r=>r["Partner Name"]===p);
    const targ = rs.reduce((s,r)=>s + (r._computed? r._computed.targets:0),0);
    const ach = rs.reduce((s,r)=>s + (r._computed? r._computed.cum_total:0),0);
    const pct = targ? (ach / targ * 100):0;
    return { p, pct };
  }).sort((a,b)=>b.pct - a.pct).slice(0,10);

  topPartnersCh.setOption({ title:{text:'Top Partners'}, legend:{top:10}, xAxis:{ type:'category', data:pAgg.map(x=>x.p) }, yAxis:{ type:'value' }, series:[ { type:'bar', data:pAgg.map(x=>Math.round(x.pct)), label:{show:true, formatter:'{c}%'} } ] });

  // mechanisms
  const mechs = [...new Set(recs.map(r=>r["Mechanism Name"]).filter(Boolean))];
  const mAgg = mechs.map(m=> {
    const rs = recs.filter(r=>r["Mechanism Name"]===m);
    const targ = rs.reduce((s,r)=>s + (r._computed? r._computed.targets:0),0);
    const ach = rs.reduce((s,r)=>s + (r._computed? r._computed.cum_total:0),0);
    const pct = targ? (ach / targ * 100):0;
    return { m, pct };
  }).sort((a,b)=>b.pct - a.pct).slice(0,10);

  topMechsCh.setOption({ title:{text:'Top Mechanisms'}, legend:{top:10}, xAxis:{ type:'category', data:mAgg.map(x=>x.m) }, yAxis:{ type:'value' }, series:[ { type:'bar', data:mAgg.map(x=>Math.round(x.pct)), label:{show:true, formatter:'{c}%'} } ] });
}

/* ---------- 7. QoC charts (Line race, Bar race, Numerator/Denominator proportion) ---------- */
function renderQoC(recs) {
  const chLine = safeInit('qocLineRace');
  const chBar = safeInit('qocBarRace');
  const chNumDen = safeInit('qocNumDen');

  // For Line race: time series of a select QoC indicator (we'll take top indicator by count or user-filtered indicator)
  // We'll build FY-wise proportions for proportion-class records OR compute proportion = num/den if both available.

  // Build dataset: group by Fiscal Year and Indicator Type
  const years = [...new Set(recs.map(r=>String(r["Fiscal Year"])).filter(Boolean))].sort();
  const indicators = [...new Set(recs.map(r=>r.Indicator).filter(Boolean))];

  // Choose indicator to plot (if user selected, use that; else pick first proportion-type or first indicator)
  const selIndicator = $('#indicatorFilter').val();
  let chosenIndicator = (selIndicator && selIndicator.length) ? selIndicator[0] : null;
  if (!chosenIndicator) {
    // prefer proportion-type indicator
    const prop = indicators.find(ind => ind && /RATE|RATIO|PVLS|PV|PROPORTION|PCT/i.test(ind));
    chosenIndicator = prop || indicators[0] || null;
  }
  // Build line series: for chosenIndicator compute percent per FY
  const lineData = years.map(y => {
    const rs = recs.filter(r=>String(r["Fiscal Year"])===y && r.Indicator===chosenIndicator);
    if (!rs.length) return 0;
    // if record has Numerator & Denominator fields compute proportion
    const nums = rs.reduce((s,r)=> s + (r.Numerator? N(r.Numerator) : (r._computed? r._computed.cum_total:0) ), 0);
    const dens = rs.reduce((s,r)=> s + (r.Denominator? N(r.Denominator) : (r.Targets? N(r.Targets) : 0) ), 0);
    return dens ? (nums / dens * 100) : (rs.reduce((s,r)=>s + (r._computed? r._computed.percent:0),0) / rs.length);
  });

  chLine.setOption({
    title: { text: `QoC - ${chosenIndicator} (Line race by FY)`, left:'center' },
    legend: { top:10 },
    tooltip: { trigger:'axis', formatter: params => {
      const i = params[0].dataIndex;
      return `${years[i]}<br>${chosenIndicator}<br>${fmtPct(Math.round(lineData[i]))}`;
    }},
    xAxis: { type:'category', data: years },
    yAxis: { type:'value', min:0, max: Math.max(...lineData,10) * 1.25, axisLabel:{ formatter: v => `${Math.round(v)}%` } },
    series: [{ name: chosenIndicator, type:'line', data: lineData.map(v=>+(v.toFixed(2))), smooth:true, symbol:'circle', symbolSize:8, itemStyle:{ color:'#00695c' }, animationDuration:1500 }]
  });

  // Bar race: Top indicators by proportion in latest FY
  const latestFY = years.slice(-1)[0];
  const barAgg = indicators.map(ind => {
    const rs = recs.filter(r=>r.Indicator===ind && String(r["Fiscal Year"])===latestFY);
    const targ = rs.reduce((s,r)=> s + (r.Targets? N(r.Targets) : 0), 0);
    const ach = rs.reduce((s,r)=> s + (r.Numerator? N(r.Numerator) : (r._computed? r._computed.cum_total:0)), 0);
    const pct = targ? (ach / targ * 100) : (rs.length? (rs.reduce((s,r)=>s + (r._computed? r._computed.percent:0),0) / rs.length) : 0);
    return { ind, pct, ach, targ };
  }).filter(x=>x.ind).sort((a,b)=>b.pct - a.pct).slice(0,10);

  chBar.setOption({
    title:{ text: `QoC Bar Race — Top (FY ${latestFY || ''})`, left:'center' },
    tooltip:{ trigger:'axis', formatter: params => {
      const i = params[0].dataIndex;
      return `${barAgg[i].ind}<br>Targets: ${fmtN(barAgg[i].targ)}<br>Achieved: ${fmtN(barAgg[i].ach)} (${Math.round(barAgg[i].pct)}%)`;
    }},
    legend:{ top:10 },
    xAxis:{ type:'value', axisLabel:{ formatter:v=>`${Math.round(v)}%` } },
    yAxis:{ type:'category', data: barAgg.map(x=>x.ind) },
    series:[ { type:'bar', data: barAgg.map(x=>+(x.pct.toFixed(2))), itemStyle:{ color:'#8e24aa' }, label:{ show:true, position:'right', formatter:(p)=> `${fmtN(barAgg[p.dataIndex].ach)} (${Math.round(barAgg[p.dataIndex].pct)}%)`} } ],
    dataZoom: [ { type:'slider', show:true, yAxisIndex:0, start:0, end:60 }, { type:'inside', yAxisIndex:0 } ]
  });

  // Numerator/Denominator proportion chart: stacked bars with proportion line
  // Build dataset grouped by Indicator or by Partner (choose indicator-level)
  const ndIndicators = indicators.slice(0,10); // limit for readability
  const numerators = ndIndicators.map(ind => recs.filter(r=>r.Indicator===ind).reduce((s,r)=> s + (r.Numerator? N(r.Numerator) : (r._computed? r._computed.cum_total:0)),0));
  const denominators = ndIndicators.map(ind => recs.filter(r=>r.Indicator===ind).reduce((s,r)=> s + (r.Denominator? N(r.Denominator) : (r.Targets? N(r.Targets) : 0)),0));
  const proportions = numerators.map((num,i)=> denominators[i] ? (num / denominators[i] * 100) : 0);

  chNumDen.setOption({
    title:{ text:'Numerator / Denominator (and proportion)', left:'center' },
    tooltip:{ trigger:'axis', axisPointer:{ type:'shadow' }, formatter: params => {
      const i = params[0].dataIndex;
      return `${ndIndicators[i]}<br>Numerator: ${fmtN(numerators[i])}<br>Denominator: ${fmtN(denominators[i])}<br>Proportion: ${Math.round(proportions[i])}%`;
    }},
    legend:{ top:10, data:['Numerator','Denominator','Proportion'], selectedMode:'multiple' },
    xAxis:{ type:'category', data: ndIndicators, axisLabel:{ rotate:30 } },
    yAxis:[ { type:'value', name:'Count' }, { type:'value', name:'Proportion %', position:'right', min:0, max: Math.max(...proportions,10) * 1.25 } ],
    series:[
      { name:'Numerator', type:'bar', stack:'counts', data: numerators, itemStyle:{ color:'#2196f3' } },
      { name:'Denominator', type:'bar', stack:'counts', data: denominators, itemStyle:{ color:'#90caf9' } },
      { name:'Proportion', type:'line', yAxisIndex:1, data: proportions.map(v=>+(v.toFixed(2))), smooth:true, symbol:'circle', symbolSize:6, itemStyle:{ color:'#ff5722' } }
    ],
    dataZoom: [ { type:'slider', show:true, start:0, end:60 }, { type:'inside' } ]
  });
}

/* ---------- Master refresh ---------- */
function refreshAll() {
  if(!raw) return;
  const recs = getFilteredRecords();

  // KPIs
  const uniquePartners = new Set(recs.map(r=>r['Partner Name']).filter(Boolean));
  const uniqueMechs = new Set(recs.map(r=>r['Mechanism Name']).filter(Boolean));
  const totalTargets = recs.reduce((s,r)=> s + (r._computed? r._computed.targets : 0),0);
  const totalAch = recs.reduce((s,r)=> s + (r._computed? r._computed.cum_total : 0),0);
  const overallPct = totalTargets ? (totalAch / totalTargets * 100) : 0;

  $('#partnerCount').text(uniquePartners.size);
  $('#mechCount').text(uniqueMechs.size);
  $('#overallSummaryPct').text(`${Math.round(overallPct)}%`);

  // Render charts
  renderTargetsChart(recs);
  renderPartnerChart(recs);
  renderMechanismChart(recs);
  renderBottomIndicators(recs);
  renderQuarterlyTrend(recs);
  renderSmallTrends(recs);
  renderQoC(recs);
}

/* Kickoff */
$(document).ready(()=> {
  loadData();
});
</script>
</body>
</html>

